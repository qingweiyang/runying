<div id="orders-main">

<!-- 面包屑导航 -->
<ul class="breadcrumb">
  <li>
     <a href="#" class="disabled">订单录入</a>
  </li>
  <li class="active">
     	录入订单
  </li>
</ul>

  <div class="col-md-7 column">
    <!-- 合同号 -->
    <div class="row clearfix form-des">
      <div class="col-md-3 column form-pre-des">
        合同号 ：
      </div>
      <div class="col-md-4 column">
        <input id="constractNumber" class="form-control">  
      </div>
      <div id="contractNumber-suf-des" class="col-md-5 column form-suf-des text-info">
        （必填）
      </div>
    </div>
    <!-- 单据编号 -->
    <div class="row clearfix form-des">
      <div class="col-md-3 column form-pre-des">
        单据编号 ：
      </div>
      <div class="col-md-4 column">
        <input id="number" class="form-control">  
      </div>
      <div id="number-suf-des" class="col-md-5 column form-suf-des text-info">
        （选填）
      </div>
    </div>
    <!-- 图号 -->
    <div class="row clearfix form-des">
      <div class="col-md-3 column form-pre-des">
        图号 ：
      </div>
      <div class="col-md-4 column">
        <input id="pictureNumber" class="form-control">  
      </div>
      <div id="pictureNumber-suf-des" class="col-md-5 column form-suf-des text-info">
        （选填）
      </div>
    </div>
    <!-- 产品名称 -->
    <div class="row clearfix form-des">
      <div class="col-md-3 column form-pre-des">
        产品名称 ：
      </div>
      <div class="col-md-4 column">
	      <div id="pdt-name-dropdown" class="input-group dropdown">
			  <input id="pdt-name" class="form-control">
			  <div class="input-group-addon">
			    <ul id="pdt-name-ul" class="dropdown-menu" aria-labelledby="dropdownMenu1" style="width:100%; max-height: 200px; overflow:auto;">
			    </ul>
			    <a data-toggle="dropdown" href="#" style="display:none;"></a>
			    <a href="javascript:getProducts('');"><span class="glyphicon glyphicon-triangle-bottom" aria-hidden="true"></span></a>
			  </div>
		  </div>
	  </div>
      <div id="pdt-name-suf-des" class="col-md-5 column form-suf-des text-info">
        （请选择系统相应产品名称）
      </div>
    </div>
    <!-- 产品数量 -->
    <div class="row clearfix form-des">
      <div class="col-md-3 column form-pre-des">
        产品数量 ：
      </div>
      <div class="col-md-4 column">
        <input id="count" class="form-control">  
      </div>
      <div id="count-suf-des" class="col-md-5 column form-suf-des text-info">
       （必填）
      </div>
    </div>
    <!-- 备注 -->
    <div class="row clearfix form-des">
      <div class="col-md-3 column form-pre-des">
        备  注 ：
      </div>
      <div class="col-md-4 column">
        <input id="remarks" class="form-control">  
      </div>
      <div class="col-md-5 column form-suf-des text-info">
        （选填）
      </div>
    </div>
    <!-- 下达日期 -->
    <div class="row clearfix form-des">
      <div class="col-md-3 column form-pre-des">
        下达日期 ：
      </div>
      <div class="col-md-4 column">
        <input id="releaseTime" type="date" class="form-control">  
      </div>
      <div id="releaseTime-suf-des" class="col-md-5 column form-suf-des text-info">
        （必填）
      </div>
    </div>
    <!-- 交货日期 -->
    <div class="row clearfix form-des">
      <div class="col-md-3 column form-pre-des">
        交货日期 ：
      </div>
      <div class="col-md-4 column">
        <input id="deliveryTime" type="date" class="form-control">  
      </div>
      <div id="deliveryTime-suf-des" class="col-md-5 column form-suf-des text-info">
        （必填）
      </div>
    </div>
  </div>
  <!-- 显示产品具体信息 -->
  <div id="pdt-detail" class="col-md-3 column pdt-panel">
  	<div id="materialID" style="display:none;">
    </div>
    <div class="row clearfix pdt-des">
      <div class="col-md-5 column pdt-pre-des">
        物料名称
      </div>
      <div id="materialName" class="col-md-7 column pdt-suf-des">
          未知
      </div>
    </div>
    <div class="row clearfix pdt-des">
      <div class="col-md-5 column pdt-pre-des">
        size1
      </div>
      <div id="size1" class="col-md-7 column pdt-suf-des">
        未知
      </div>
    </div>
    <div class="row clearfix pdt-des">
      <div class="col-md-5 column pdt-pre-des">
        size2
      </div>
      <div id="size2" class="col-md-7 column pdt-suf-des">
        未知
      </div>
    </div>
    <div class="row clearfix pdt-des">
      <div class="col-md-5 column pdt-pre-des">
        物料长代码
      </div>
      <div id="materialCode" class="col-md-7 column pdt-suf-des">
        未知
      </div>
    </div>
    <div class="row clearfix pdt-des">
      <div class="col-md-5 column pdt-pre-des">
        材质
      </div>
      <div id="material" class="col-md-7 column pdt-suf-des">
        未知
      </div>
    </div>
  </div>

  <legend class="valtype"></legend>

  <div class="row clearfix form-des">
    <div class="col-md-2 column">
      <button type="button" class="btn btn-danger btn-lg btn-block">重新填写</button>
    </div>
    <div class="col-md-2 col-md-offset-1 column">
      <button type="button" class="btn btn-primary btn-lg btn-block" onclick="submit()">确认提交</button>
    </div>
  </div>

</div>
<script type="text/javascript">
var products;
$(document).ready(function() {
	$('#pdt-name').bind('input propertychange', function() {
	   getProducts($("#pdt-name").val());
	 });
});

function submit() {
    var orders = {};
    //orders.orderNum = $("#orderNum").val();
    orders.contractNumber = $("#constractNumber").val();
    orders.number = $("#number").val();
    orders.pictureNumber = $("#pictureNumber").val();
    orders.count = $("#count").val();
    orders.remarks = $("#remarks").val();
    orders.releaseTime = $("#releaseTime").val();
    orders.deliveryTime = $("#deliveryTime").val();
    var pdt = {};
    pdt.id = $("#materialID").text();
    pdt.materialName = $("#materialName").text();
    pdt.size1 = $("#size1").text();
    pdt.size2 = $("#size2").text();
    pdt.materialCode = $("#materialCode").text();
    orders.product = pdt;
    
    clearWarningMsg();

    //检查输入是否合法
    var isValid = 1;
    if("" == orders.contractNumber) {
      $("#contractNumber-suf-des").text("合同号不能为空");
      $("#contractNumber-suf-des").addClass("text-danger");
      isValid = 0;
    }
    //测试是否为正整数
    var type = "^[0-9]*[1-9][0-9]*$"; 
    var re = new RegExp(type);
    if("" == orders.count || orders.count.match(re) == null) { 
      $("#count-suf-des").text("产品数量只能是大于0的整数");
      $("#count-suf-des").addClass("text-danger");
      isValid = 0;
    }

    //检查产品是否选择
    if("" == $("#pdt-name").val()) {
    	$("#pdt-name-suf-des").text("产品必须选择");
        $("#pdt-name-suf-des").addClass("text-danger");
        isValid = 0;
    }
    
    //检查下达日期是否输入
    if("" == orders.releaseTime) {
      $("#releaseTime-suf-des").text("下达日期必须输入");
      $("#releaseTime-suf-des").addClass("text-danger");
      isValid = 0;
    }

    //检查交货日期是否输入
    if("" == orders.deliveryTime) {
      $("#deliveryTime-suf-des").text("交货日期必须输入");
      $("#deliveryTime-suf-des").addClass("text-danger");
      isValid = 0;
    }

    if(!isValid) {
      return;
    }
    $.ajax({
      type : "POST",
      contentType : 'application/json', 
      url : "ordersIn.do",
      data : JSON.stringify(orders), 
      dataType: "json",
      success : function(data) {
          if(data.status == 1) {
        	  showSubmitOrdersSuccess();
          } else {
            alert(data.description);
          }
      },
      error : function(){
          alert("error");
      }
    });
}

//提交前清除错误提示信息
function clearWarningMsg() {
  $("#contractNumber-suf-des").text("（必填）");
  $("#contractNumber-suf-des").removeClass("text-danger");
  
  $("#pdt-name-suf-des").text(" （请选择系统相应产品名称）");
  $("#pdt-name-suf-des").removeClass("text-danger");
  
  $("#count-suf-des").text("（必填）");
  $("#count-suf-des").removeClass("text-danger");

  $("#releaseTime-suf-des").text("（必填）");
  $("#releaseTime-suf-des").removeClass("text-danger");

  $("#deliveryTime-suf-des").text("（必填）");
  $("#deliveryTime-suf-des").removeClass("text-danger");
}

// 提交工序成功，跳转到成功页面
function showSubmitOrdersSuccess() {
  $("#orders-main").empty();
  $("#orders-main").load("../orders/orders_in_suc.html", function() {

  });
}

function getProducts(search) {
	$("#pdt-name-ul").children().remove();
	$.get(
		"getProducts.do",
		"search="+search,
		function(data) {
		  products = data;
	      $.each(data,function(i,item){
	  	    $("#pdt-name-ul").append('<li><a href="javascript:void(0);" onclick="showPdt('+item.id+');" onmouseover="showPdt('+item.id+');">'+item.materialName+' '+item.size1+'</a></li>');
	  	    
	  	    if(!($(".input-group-addon").hasClass("open"))) {
	  	      $(".dropdown-menu").dropdown('toggle');
	  	    }
	      });
		});
}

function showPdt(curID) {
	$.each(products,function(i,item){
        if(item.id == curID) {
            var materialNameFromJson = item.materialName;
            var size1FromJson = item.size1;
            var size2FromJson = item.size2;
            var materialCodeFromJson = item.materialCode;
            var materialFromJson = item.material;
            $("#materialID").text(curID);
            $("#materialName").text(materialNameFromJson);
            $("#size1").text(size1FromJson);
            $("#size2").text(size2FromJson);
            $("#materialCode").text(materialCodeFromJson);
            $("#material").text(materialFromJson);
            
            $("#pdt-name").val(item.materialName+" "+item.size1);
        }
    });
}
</script>